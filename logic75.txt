#include "vars.txt"

LOGIC__HEADER

#define rfRAT_IS_HERE rf0
#define rfRAT_CAUGHT_YOU rf1
#define rfWARNED_RAT_CAN_SMELL_YOU rf2
#define rfDOOR_OPEN rf3
#define rfRAT_LEFT rf4

#define rvRAT_STEP_SIZE rv0

#define oRAT o1
#define oDOOR o2

if (fROOM_SCRIPT_EXECUTED) {
  load.pic(vROOM_NO);
  draw.pic(vROOM_NO);
  discard.pic(vROOM_NO);
  if (vPREV_ROOM_NO == ROOM74_CAVE_CORNER) {
    get.posn(oEGO, vTEMP_X, vTEMP_Y);
    vTEMP_X += 150;
    position.v(oEGO, vTEMP_X, vTEMP_Y);
  }
  if (vPREV_ROOM_NO == ROOM76_LEPRECHAUN_ANTECHAMBER) {
    position(oEGO, 34, 125);
  }
  ignore.objs(oEGO);
  load.view(95);
  if (!fRAT_IS_GONE) {
    load.sound(SND_VILLAIN);
    load.view(45);
    animate.obj(oRAT);
    set.view(oRAT, 45);
    position(oRAT, 36, 127);
    set(rfRAT_IS_HERE);
    follow.ego(oRAT, 15, rfRAT_CAUGHT_YOU);
    observe.blocks(oRAT);
    rvRAT_STEP_SIZE = 3;
    step.size(oRAT, rvRAT_STEP_SIZE);
  }
  load.sound(SND_DOOR_OPENING);
  load.view(46);
  animate.obj(oDOOR);
  set.view(oDOOR, 46);
  if (vPREV_ROOM_NO == ROOM76_LEPRECHAUN_ANTECHAMBER) {
    set.cel(oDOOR, 5);
  }
  else {
    set.cel(oDOOR, 0);
  }
  ignore.blocks(oDOOR);
  set.priority(oDOOR, 9);
  position(oDOOR, 25, 119);
  draw(oDOOR);
  if (rfRAT_IS_HERE) {
    draw(oRAT);
  }
  draw(oEGO);
  show.pic();
  if (vPREV_ROOM_NO == ROOM76_LEPRECHAUN_ANTECHAMBER) {
    reverse.loop(oDOOR, f203);
    sound(SND_DOOR_OPENING, fMISC_END_MARKER);
  }
  else {
    stop.update(oDOOR);
  }
}
if (f203) {
  reset(f203);
  stop.update(oDOOR);
}
if (rfRAT_IS_HERE) {
  reset(rfRAT_IS_HERE);
  sound(SND_VILLAIN, fMISC_END_MARKER);
}
if (posn(oEGO, 0, 0, 54, 167)) {
  observe.blocks(oEGO);
}
else {
  ignore.blocks(oEGO);
}
if (fEGO_INVISIBLE && !rfWARNED_RAT_CAN_SMELL_YOU) {
  set(rfWARNED_RAT_CAN_SMELL_YOU);
  print("Being invisible won't hide you from this rat's keen sense of smell.");
}
if (fRAT_IS_GONE) {
  if (said("anyword", "rat") || said("anyword", "mouse")) {
    print("There is no rat here.");
  }
  if (said("examine", "cave") || said("examine", "room")) {
    print("It is very dark and dreary in here.");
  }
}
if (!fRAT_IS_GONE) {
  distance(oEGO, oRAT, vTEMP_RESULT_2);
  if (said("examine", "rat")) {
    print("It is a big rat with dripping teeth and small, greedy eyes.");
  }
  if (said("examine", "cave") || said("examine", "room")) {
    print("It is very dark and dreary.  The rat seems to like it here.");
  }
  if (said("examine", "mouse")) {
    print("This is no mouse, this is a big, ugly rat!");
  }
  if (said("pet", "rat")) {
    print("What!  Are you crazy?");
  }
  if (said("murder", "rat")) {
    print("You can't.  He moves too quickly.");
  }
  if (said("talk", "rat") || said("hello") || said("say", "hello")) {
    print("The rat rasps, \"Treasure!  Treasure!  Give treasure, or no go door!  Give treasure NOW!\"");
  }
  if (said("give", "treasure")
    || said("give", "rat", "treasure")
    || said("give", "treasure", "rat")
  ) {
    print("What kind of treasure would you like to give the  greedy rat?");
  }
  if (!fCARRYING_DIAMONDS) {
    if (said("give", "bag of jewels")
      || said("give", "rat", "bag of jewels")
      || said("give", "bag of jewels", "rat")
    ) {
      if (fCARRYING_POUCH && vTEMP_RESULT_2 < 35) {
        print("The rat doesn't want a tattered pouch.");
      }
      else {
        print("It appears you are afraid of the rat!  You must get closer to give anything to this rat!");
      }
    }
  }
  if (fCARRYING_DIAMONDS) {
    if (said("give", "pouch of diamonds")
      || said("give", "rat", "pouch of diamonds")
      || said("give", "pouch of diamonds", "rat")
      || said("give", "bag of jewels")
      || said("give", "rat", "bag of jewels")
      || said("give", "bag of jewels", "rat")
    ) {
      if (fCARRYING_DIAMONDS && vTEMP_RESULT_2 < 35) {
        print("The huge rat takes the treasure you have offered and scuttles away.");
        move.obj(oRAT, 46, 105, 0, rfRAT_LEFT);
        drop("pouch of diamonds");
        reset(fCARRYING_DIAMONDS);
        set(fDWARF_OR_TROLL_HAS_DIAMONDS);
        vSCORE -= 6;
      }
      else {
        print("It appears you are afraid of the rat!  You must get closer to give anything to this rat!");
      }
    }
  }
  if (said("give", "golden egg")
    || said("give", "rat", "golden egg")
    || said("give", "golden egg", "rat")) {
    if (fCARRYING_GOLDEN_EGG && vTEMP_RESULT_2 < 35) {
      print("The huge rat takes the treasure you have offered and scuttles away.");
      move.obj(oRAT, 46, 105, 0, rfRAT_LEFT);
      drop("gold egg");
      reset(fCARRYING_GOLDEN_EGG);
      set(fDWARF_OR_TROLL_HAS_EGG);
      vSCORE -= 6;
    }
    else {
      print("It appears you are afraid of the rat!  You must get closer to give anything to this rat!");
    }
  }
  if (said("give", "walnut") || said("give", "rat", "walnut") || said("give", "walnut", "rat")) {
    if (fCARRYING_WALNUT) {
      if (vTEMP_RESULT_2 < 35) {
        print("The rat doesn't want an ordinary walnut.");
      }
      else {
        print("It appears you are afraid of the rat!  You must get closer to give anything to this rat!");
      }
    }
    if (fCARRYING_GOLD_WALNUT) {
      if (vTEMP_RESULT_2 < 35) {
        print("The huge rat takes the treasure you have offered and scuttles away.");
        move.obj(oRAT, 46, 105, 0, rfRAT_LEFT);
        drop("gold walnut");
        reset(fCARRYING_GOLD_WALNUT);
        set(fDWARF_OR_TROLL_HAS_WALNUT);
        vSCORE -= 6;
      }
      else {
        print("It appears you are afraid of the rat!  You must get closer to give anything to this rat!");
      }
    }
  }
  if (said("give", "sceptre")
    || said("give", "rat", "sceptre")
    || said("give", "sceptre", "rat")
  ) {
    if (fCARRYING_SCEPTRE && vTEMP_RESULT_2 < 35) {
      print("The huge rat takes the treasure you have offered and scuttles away.");
      move.obj(oRAT, 46, 105, 0, rfRAT_LEFT);
      drop("sceptre");
      reset(fCARRYING_SCEPTRE);
      set(fDWARF_OR_TROLL_HAS_SCEPTRE);
      vSCORE -= 6;
    }
    else {
      print("It appears you are afraid of the rat!  You must get closer to give anything to this rat!");
    }
  }
  if (said("give", "swiss cheese")
    || said("give", "rat", "swiss cheese")
    || said("give", "swiss cheese", "rat")
    || said("feed", "swiss cheese")
    || said("feed", "rat", "swiss cheese")
    || said("feed", "swiss cheese", "rat")
  ) {
    if (!fCARRYING_SWISS_CHEESE) {
      print("That is a good idea, but you do not have any cheese.");
    }
    if (fCARRYING_SWISS_CHEESE) {
      if (vTEMP_RESULT_2 < 35) {
        print("The rat drools at the sight of the cheese... and snatches it from your hand.  You might want to count your fingers.");
        move.obj(oRAT, 46, 105, 0, rfRAT_LEFT);
        drop("cheese");
        reset(fCARRYING_SWISS_CHEESE);
        set(fRAT_ATE_CHEESE);
        vSCORE -= 2;
        vSCORE += 4;
      }
      else {
        print("It appears you are afraid of the rat!  You must get closer to give anything to this rat!");
      }
    }
  }
}
if (rfRAT_LEFT) {
  reset(rfRAT_LEFT);
  erase(oRAT);
  set(fRAT_IS_GONE);
  print("The rat scrambles to the wall and seems to magically merge with it.");
}
if (said("count", "fingers") || said("examine", "fingers")) {
  print("You count your fingers and are relieved to see you still have all of them.");
}
if (rfRAT_CAUGHT_YOU) {
  set.view(oEGO, 95);
  print("Be careful around this rat next time!  He's dangerous!!");
  wander(oRAT);
  set(fGAME_OVER);
}
distance(oEGO, oDOOR, vTEMP_RESULT_3);
if (said("open", "doors")) {
  if (vTEMP_RESULT_3 < 25) {
    start.update(oDOOR);
    sound(SND_DOOR_OPENING, fMISC_END_MARKER);
    print("The door slowly opens.");
    end.of.loop(oDOOR, rfRAT_LEFT);
  }
  else {
    print("Get closer if you want to try.");
  }
}
if (rfRAT_LEFT) {
  new.room(ROOM76_LEPRECHAUN_ANTECHAMBER);
}
if (said("close", "doors")) {
  print("It is already closed.");
}
if (said("examine", "doors")) {
  print("The door is closed.");
}
if (vEGO_EDGE_CODE == EDGE_RIGHT) {
  new.room(ROOM74_CAVE_CORNER);
}
return;

LOGIC__FOOTER

