#include "vars.txt"

LOGIC__HEADER

#define oMAGIC_MIRROR o1
#define oDRAGON o3

if (fROOM_SCRIPT_EXECUTED) {
  load.pic(vROOM_NO);
  draw.pic(vROOM_NO);
  discard.pic(vROOM_NO);
  if (!f165) {
    load.view(34);
  }
  if (vDRAGON_STATE == DRAGONSTATE_DEAD) {
    load.view(61);
  }
  if (vDRAGON_STATE == DRAGONSTATE_NORMAL) {
    load.view(33);
    load.view(61);
    load.view(82);
    load.sound(SND_VILLAIN);
    load.sound(7);
  }
  load.view(35);
  if (vPREV_ROOM_NO == 52) {
    set.view(oEGO, 0);
    reset(f98);
    v94 = 0;
    position(oEGO, 133, 136);
    if (!f167) {
      set(f167);
      vSCORE += 1;
    }
  }
  if (vPREV_ROOM_NO == 50) {
    position(oEGO, 9, 138);
  }
  if (!f165) {
    animate.obj(oMAGIC_MIRROR);
    set.view(oMAGIC_MIRROR, 34);
    position(oMAGIC_MIRROR, 38, 108);
    draw(oMAGIC_MIRROR);
    stop.update(oMAGIC_MIRROR);
  }
  if (vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    animate.obj(o2);
    set.view(o2, 35);
    ignore.blocks(o2);
    position(o2, 8, 127);
    draw(o2);
    stop.cycling(o2);
  }
  if (vDRAGON_STATE != DRAGONSTATE_ABSENT) {
    animate.obj(o2);
    set.view(o2, 35);
    ignore.blocks(o2);
    position(o2, 3, 127);
    draw(o2);
    stop.cycling(o2);
    animate.obj(oDRAGON);
    if (vDRAGON_STATE == DRAGONSTATE_DEAD) {
      add.to.pic(61, 0, 0, 40, 152, 0, 0);
    }
    if (vDRAGON_STATE == DRAGONSTATE_NORMAL) {
      set.view(oDRAGON, 33);
      position(oDRAGON, 40, 120);
      v30 = 3;
      step.size(oDRAGON, v30);
      draw(oDRAGON);
      observe.blocks(oDRAGON);
      follow.ego(oDRAGON, 20, f20);
    }
  }
  draw(oEGO);
  show.pic();
}
get.posn(oEGO, v60, v61);
if (v60 > 15) {
  ignore.blocks(oEGO);
}
if (v60 < 16) {
  if (vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    ignore.blocks(oEGO);
  }
  else {
    observe.blocks(oEGO);
  }
}
if (vDRAGON_STATE == DRAGONSTATE_NORMAL && !f24) {
  set(f24);
  sound(SND_VILLAIN, f25);
}
if (vDRAGON_STATE == DRAGONSTATE_NORMAL && f25) {
  current.loop(oDRAGON, v31);
  if (v31 == 0) {
    sound(7, f148);
  }
  else {
    stop.sound();
  }
}
if (f20 && vDRAGON_STATE == DRAGONSTATE_NORMAL) {
  reset(f20);
  set.view(oEGO, 82);
  if (fCARRYING_SHIELD) {
    print("Your shield melted from the intensity of the dragon's flames!  You should know about these fire-breathing dragons!  Maybe next time you will be a little more careful!");
  }
  else {
    print("You should know about these fire-breathing dragons!  Maybe next time you will be a little more careful!");
  }
  set(fGAME_OVER);
}
if (said("examine", "room")) {
  if (!f165 && vDRAGON_STATE == DRAGONSTATE_NORMAL) {
    print("The ferocious fire-breathing dragon is protecting the magic mirror.");
  }
  if (!f165 && vDRAGON_STATE == DRAGONSTATE_DEAD) {
    print("There is a dead dragon, a large boulder, and a seemingly ordinary mirror in the cave.");
  }
  if (!f165 && vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    print("There is a large granite boulder and a magic mirror!! in the cave.");
  }
}
if (said("examine", "cave")) {
  if (!f165 && vDRAGON_STATE == DRAGONSTATE_NORMAL) {
    print("A green, scaly dragon breathing hot fire and smoke is protecting the mirror.");
  }
  if (f165 && vDRAGON_STATE == DRAGONSTATE_DEAD) {
    print("In this large cavern, there is a slimy dead dragon, an opening on one side, and a large boulder in the other.");
  }
  if (!f165 && vDRAGON_STATE == DRAGONSTATE_DEAD) {
    print("There is a dead dragon, a large boulder, and a seemingly ordinary mirror in the cave.");
  }
  if (!f165 && vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    print("There is a large granite boulder and a magic mirror!! in the cave.");
  }
  if (f165 && vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    print("The cavern is empty, save for a couple of openings on either side.");
  }
}
if (said("examine", "dragon")) {
  if (vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    print("There is no dragon here.");
  }
  if (vDRAGON_STATE == DRAGONSTATE_NORMAL) {
    print("This ferocious, fire-breathing dragon with sharp, green scales and a long tail is protecting the magic mirror. Watch out for the flames!");
  }
  if (vDRAGON_STATE == DRAGONSTATE_DEAD) {
    print("You see the once powerful dragon lying lifeless before you.");
  }
}
if (said("find", "dragon")) {
  if (vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    print("There is no dragon here.");
  }
  if (vDRAGON_STATE == DRAGONSTATE_NORMAL || vDRAGON_STATE == DRAGONSTATE_DEAD) {
    print("I think you found the dragon!");
  }
}
if (said("examine", "stalactites") || said("examine", "stalactites")) {
  print("It took millenniums for these stalagmites and stalactites to form.");
}
if (said("examine", "rocks")) {
  print("This boulder is a huge chunk of granite.");
}
if (said("shove", "rocks") || said("shove", "rocks")) {
  print("This boulder is far too heavy to move.");
}
if (vDRAGON_STATE == DRAGONSTATE_NORMAL) {
  if (said("examine", "hole") || said("look inside", "hole")) {
    print("A strange watery light issues from the hole.");
  }
  if (said("talk", "dragon") || said("hello") || said("say", "hello")) {
    print("This dragon does not respond to reason.");
  }
}
if (vDRAGON_STATE != DRAGONSTATE_NORMAL) {
  if (said("examine", "hole") || said("look inside", "hole")) {
    if (posn(oEGO, 1, 1, 75, 166)) {
      print("The hole seems to lead further into the cave.");
    }
    else {
      print("A strange watery light issues from the hole.");
    }
  }
}
if (vDRAGON_STATE == DRAGONSTATE_DEAD) {
  if (said("get", "dagger")) {
    print("The mere thought of retrieving the dagger repulses you.");
  }
}
if (fCARRYING_DAGGER) {
  if (said("use", "dagger")) {
    print("How?");
  }
}
if (said("murder", "dragon")) {
  if (vDRAGON_STATE == DRAGONSTATE_ABSENT) {
    print("How?");
  }
  if (vDRAGON_STATE == DRAGONSTATE_DEAD) {
    print("This dragon had only one life and you have taken it.");
  }
  if (vDRAGON_STATE == DRAGONSTATE_NORMAL) {
    if (posn(oEGO, 105, 96, 145, 166)) {
      print("You can't do that from here.!");
    }
    else {
      print("How do you wish to accomplish that?");
    }
  }
}
if (fCARRYING_BUCKET) {
  if (said("throw", "bucket")) {
    print("You throw your bucket on the cavern floor.");
    reset(fCARRYING_BUCKET);
    drop("water bucket");
    vSCORE -= 2;
    if (fBUCKET_FILLED) {
      reset(fBUCKET_FILLED);
      drop("water");
      reset(fFILL_BUCKET_POINTS);
      vSCORE -= 2;
    }
  }
}
if (!fCARRYING_MIRROR && f165) {
  if (said("anyword", "mirror")) {
    print("There is no mirror here.");
  }
}
if (!fCARRYING_MIRROR && !f165) {
  if (said("steal", "mirror") && vDRAGON_STATE == DRAGONSTATE_NORMAL) {
    print("With that dragon here?  No way!");
  }
  if (posn(oEGO, 26, 104, 59, 127)) {
    if (said("examine", "mirror")) {
      if (vDRAGON_STATE == DRAGONSTATE_NORMAL) {
        print("The dragon is protecting the magic mirror.");
      }
      if (vDRAGON_STATE == DRAGONSTATE_ABSENT || vDRAGON_STATE == DRAGONSTATE_DEAD) {
        print("The magic mirror is framed with ornate mahogany wood, polished to a high sheen.");
      }
    }
    if (said("get", "mirror")) {
      if (vDRAGON_STATE == DRAGONSTATE_NORMAL) {
        print("I do not think that you can get close enough to the magic mirror with the dragon here.");
      }
      if (vDRAGON_STATE == DRAGONSTATE_ABSENT || vDRAGON_STATE == DRAGONSTATE_DEAD) {
        start.update(oMAGIC_MIRROR);
        erase(oMAGIC_MIRROR);
        set(fCARRYING_MIRROR);
        set(f165);
        get("magic mirror");
        print("Carefully, you pick up the magic mirror.");
        vTREASURE_COUNT++;
        vSCORE += 8;
      }
    }
  }
  if (!posn(oEGO, 26, 104, 59, 127)) {
    if (said("examine", "mirror")) {
      print("You could get a much better view if you were closer.");
    }
    if (said("get", "mirror")) {
      print("You are not close enough to reach it.");
    }
  }
}
if (!fBUCKET_FILLED) {
  if (said("douse", "dragon") || said("throw", "water") || said("throw", "water", "dragon")) {
    if (vDRAGON_STATE != DRAGONSTATE_ABSENT) {
      print("You have nothing with which to douse a dragon.");
    }
    if (vDRAGON_STATE == DRAGONSTATE_ABSENT) {
      print("There is no dragon here.");
    }
  }
}
if (posn(oEGO, 105, 96, 145, 166) && vDRAGON_STATE == DRAGONSTATE_NORMAL) {
  if (fCARRYING_DAGGER && said("throw", "dagger")) {
    reset(fCARRYING_DAGGER);
    print("The dagger sings through the air, but falls short of the dragon.  You should have been closer.");
    drop("dagger");
    vSCORE -= 5;
  }
  if (fBUCKET_FILLED && (said("throw", "water") || said("throw", "water", "dragon") || said("douse", "dragon"))) {
    reset(fBUCKET_FILLED);
    print("You throw your water, but to no avail.  It lands on the floor and is quickly absorbed.");
    drop("water");
    vSCORE -= 2;
    reset(fFILL_BUCKET_POINTS);
  }
}
if (!posn(oEGO, 105, 96, 145, 166) && vDRAGON_STATE == DRAGONSTATE_NORMAL) {
  if (fBUCKET_FILLED && (said("throw", "water") || said("throw", "water", "dragon") || said("douse", "dragon"))) {
    reset(fBUCKET_FILLED);
    print("The water hits the dragon squarely in the mouth, extinguishing its roaring flames.  No fire!  How mortified and embarrassed the dragon is!  Moving a huge boulder in leaving, the dragon creeps off to sulk.");
    drop("water");
    vSCORE -= 2;
    vSCORE += 7;
    reset(fFILL_BUCKET_POINTS);
    move.obj(oDRAGON, 40, 137, 0, f21);
    vDRAGON_STATE = DRAGONSTATE_ABSENT;
  }
  if (fCARRYING_DAGGER && said("throw", "dagger")) {
    ignore.blocks(oDRAGON);
    reset(fCARRYING_DAGGER);
    print("Nervously, you throw the dagger at the dragon and strike it in the heart.  Death for the dragon is instant.");
    drop("dagger");
    vSCORE -= 5;
    vSCORE += 3;
    erase(oDRAGON);
    set.view(oDRAGON, 61);
    v30 = 0;
    step.size(oDRAGON, v30);
    draw(oDRAGON);
    stop.motion(oDRAGON);
    stop.cycling(oDRAGON);
    vDRAGON_STATE = DRAGONSTATE_DEAD;
  }
}
if (f21) {
  reset(f21);
  start.cycling(o2);
  end.of.loop(o2, f22);
}
if (f22) {
  ignore.blocks(oDRAGON);
  reset(f22);
  stop.cycling(o2);
  move.obj(oDRAGON, 4, 137, 0, f23);
}
if (f23) {
  reset(f23);
  erase(oDRAGON);
}
if (vEGO_EDGE_CODE == EDGE_RIGHT) {
  new.room(52);
}
if (posn(oEGO, 0, 0, 1, 167)) {
  new.room(50);
}
return;

LOGIC__FOOTER

