#include "vars.txt"

LOGIC__HEADER

#define rfFINISHED_MOVING_ASIDE2 rf0
#define rfNEAR_THRONE rf1
#define rfEGO_FINISHED_BOWING rf2
#define rfWAIT_FOR_KEY rf3
#define rfBOWING rf4
#define rfBOWING2 rf5
#define rfKING_EDWARD_DEAD rf6
#define rfEGO_ON_THE_THRONE rf7
#define rfFINISHED_MOVING_ASIDE rf8

#define rvCOUNTDOWN rv0
#define rvEGO_CYCLE_TIME rv1
#define rvKING_CYCLE_TIME rv2

#define oKING o14

if (fROOM_SCRIPT_EXECUTED) {
  load.pic(vROOM_NO);
  draw.pic(vROOM_NO);
  discard.pic(vROOM_NO);
  v70 = 0;
  v71 = 0;
  if (vPREV_ROOM_NO == ROOM54_CASTLE_HALL_CORNER) {
    position(oEGO, 154, 120);
  }
  load.view(1);
  load.view(71);
  load.view(53);
  load.view(85);
  load.view(98);
  load.view(142);
  animate.obj(oKING);
  set.view(oKING, 53);
  position(oKING, 30, 90);
  draw(oKING);
  stop.cycling(oKING);
  draw(oEGO);
  show.pic();
  if (vTREASURE_COUNT == 3) {
    v70 = 250;
    v71 = 1;
  }
}
if (rfKING_EDWARD_DEAD) {
  if (said("examine", "king")) {
    print("You are the only King here!");
  }
}
if (f195) {
  return;
}
if (rvCOUNTDOWN == 0) {
  v70--;
  if (v70 == 1) {
    if (v71 != 0) {
      v71--;
      v70 = 250;
    }
  }
  if (v70 == 1 && v71 == 0) {
    v70 = 0;
    rvCOUNTDOWN = 250;
  }
}
if (rvCOUNTDOWN != 0) {
  rvCOUNTDOWN--;
  if (rvCOUNTDOWN == 245) {
    set.view(oEGO, 0);
    if (fEGO_INVISIBLE) {
      print("The spell to make you invisible has expired and you are once again visible.");
      vINVISIBLE_COUNTDOWN_LO = 0;
      vINVISIBLE_COUNTDOWN_HI = 0;
      reset(fEGO_INVISIBLE);
      drop("ring");
      vSCORE -= 3;
      reset(fCARRYING_RING);
    }
    ignore.blocks(oEGO);
    get.posn(oEGO, vTEMP_X_2, vTEMP_Y_2);
    if (vTEMP_X_2 < 60 && vTEMP_Y_2 < 88) {
      move.obj(oEGO, 67, 82, 0, rfFINISHED_MOVING_ASIDE);
    }
    else {
      move.obj(oEGO, 60, 105, 0, rfFINISHED_MOVING_ASIDE2);
    }
    print("You move aside as the King steps from his throne.");
  }
  if (rfFINISHED_MOVING_ASIDE) {
    reset(rfFINISHED_MOVING_ASIDE);
    move.obj(oEGO, 60, 105, 0, rfFINISHED_MOVING_ASIDE2);
  }
  if (rfFINISHED_MOVING_ASIDE2) {
    reset(rfFINISHED_MOVING_ASIDE2);
    set(f95);
    set.loop(oEGO, 3);
    stop.motion(oEGO);
    stop.cycling(oEGO);
    rvCOUNTDOWN = 200;
  }
  if (f95) {
    if (rvCOUNTDOWN == 195) {
      erase(oKING);
      set.view(oKING, 98);
      position(oKING, 40, 90);
      draw(oKING);
      start.cycling(oKING);
      ignore.blocks(oKING);
      rvKING_CYCLE_TIME = 2;
      cycle.time(oKING, rvKING_CYCLE_TIME);
      move.obj(oKING, 55, 95, 0, f148);
      print("As you approach the throne, the King himself rises to commend  you for a job well done.");
      if (said("examine", "king")) {
        print("The King is walking towards you to commend you.");
      }
    }
    if (rvCOUNTDOWN == 165) {
      erase(oKING);
      set.view(oKING, 85);
      draw(oKING);
      end.of.loop(oKING, rfKING_EDWARD_DEAD);
      print("\"Oh!... Oh!!\"  the King proclaims in pain!");
      if (said("examine", "king")) {
        print("Your heart also aches with pain as you watch the King.");
      }
    }
    if (rvCOUNTDOWN == 135) {
      print("From the seemingly lifeless King you hear these words:   \"Well done, Sir Graham.  You have been a good and faithful servant.  Your reward is well deserved.  My kingdom is now yours.\"");
      if (said("examine", "king")) {
        print("The King is lying motionless on the ground.");
      }
    }
    if (rvCOUNTDOWN == 115) {
      set.view(oEGO, 1);
      print("With those words, King Edward the Benevolent dies.");
    }
    if (rvCOUNTDOWN == 105) {
      program.control();
      print("The experiences of your quest will be invaluable to you as you begin your reign as King of Daventry!!");
      reset(f95);
      start.cycling(oEGO);
      ignore.objs(oEGO);
      ignore.blocks(oEGO);
      move.obj(oEGO, 40, 90, 0, rfEGO_ON_THE_THRONE);
    }
  }
}
if (rfEGO_ON_THE_THRONE) {
  reset(rfEGO_ON_THE_THRONE);
  erase(oEGO);
  position(oEGO, 30, 85);
  set.view(oEGO, 142);
  draw(oEGO);
  stop.motion(oEGO);
  prevent.input();
  print("    Thank you for playing             King's Quest                     from               Ken and Roberta Williams     Sol Ackerman   Chris Iden           Jeff Stevenson                 Mark Crowe            Bob Ballew   Mikel Knight             Susan Lee          ");
  set(f195);
}
if (posn(oEGO, 18, 80, 67, 107)) {
  set(rfNEAR_THRONE);
}
else {
  reset(rfNEAR_THRONE);
}
if (posn(oEGO, 18, 80, 86, 113)) {
  if (said("examine", "king")) {
    if (rvCOUNTDOWN == 0 && vTREASURE_COUNT != 3 && !f126) {
      print("King Edward the Benevolent is a very wise, but elderly monarch.  His frail body is almost lost in the large throne.");
    }
    if (!rfNEAR_THRONE && !fEGO_INVISIBLE && vTREASURE_COUNT == 3 && rvCOUNTDOWN == 0) {
      print("The King, though very ill, seems happy to see you.");
    }
  }
  if (said("examine", "throne")) {
    print("The King's throne is made of solid gold, accented with rubies.  It will be yours if you complete your quest.");
  }
  if (said("bow", "king") || said("bow")) {
    if (fEGO_INVISIBLE) {
      print("You bow, but you are the only one who knows it.");
    }
    else if (!fEGO_INVISIBLE && rfNEAR_THRONE) {
      print("It is proper to stand directly in front of, and a few paces back from King Edward when addressing His Eminence.");
    }
    else if (!rfNEAR_THRONE && !fEGO_INVISIBLE && rvCOUNTDOWN == 0 && vTREASURE_COUNT != 3 && !rfBOWING) {
      set(rfBOWING);
      get.posn(oEGO, vTEMP_X, vTEMP_Y);
      vTEMP_X -= 7;
      erase(oEGO);
      stop.motion(oEGO);
      set.view(oEGO, 71);
      set.cel(oEGO, 0);
      position.v(oEGO, vTEMP_X, vTEMP_Y);
      rvEGO_CYCLE_TIME = 2;
      cycle.time(oEGO, rvEGO_CYCLE_TIME);
      draw(oEGO);
      end.of.loop(oEGO, rfEGO_FINISHED_BOWING);
      set(fCYCLE_EGO_ANIMATION);
      if (!fPOINTS_FOR_BOWING_TO_THE_KING) {
        set(fPOINTS_FOR_BOWING_TO_THE_KING);
        vSCORE += 3;
      }
    }
    else if (!rfNEAR_THRONE && !fEGO_INVISIBLE && rvCOUNTDOWN == 0 && vTREASURE_COUNT == 3 && !rfBOWING2) {
      set(rfBOWING2);
      get.posn(oEGO, vTEMP_X, vTEMP_Y);
      vTEMP_X -= 7;
      erase(oEGO);
      stop.motion(oEGO);
      set.view(oEGO, 71);
      set.cel(oEGO, 0);
      position.v(oEGO, vTEMP_X, vTEMP_Y);
      rvEGO_CYCLE_TIME = 2;
      cycle.time(oEGO, rvEGO_CYCLE_TIME);
      draw(oEGO);
      end.of.loop(oEGO, rfEGO_FINISHED_BOWING);
      set(fCYCLE_EGO_ANIMATION);
      if (!fPOINTS_FOR_BOWING_TO_KING_AFTER_MISSION) {
        set(fPOINTS_FOR_BOWING_TO_KING_AFTER_MISSION);
        vSCORE += 3;
      }
    }
    else {
      print("There is no need to bow again.");
    }
  }
  if (said("talk", "king")) {
    if (fSPOKEN_TO_KING && rvCOUNTDOWN == 0 && !f126 && vTREASURE_COUNT != 3) {
      print("Go, Sir Graham!  Go and bring me back these treasures!");
    }
    if (rvCOUNTDOWN == 0 && vTREASURE_COUNT == 3) {
      print("Welcome back from your quest, Sir Graham.");
    }
    if (rvCOUNTDOWN == 0 && f126) {
      print("Why, Sir Graham, have you failed me and returned without accomplishing your task?  Go, and complete your quest!!");
      set(fNO_BUSINESS_WITH_KING);
    }
    if (rvCOUNTDOWN != 0) {
      print("The king cannot talk right now.");
    }
    if (!fSPOKEN_TO_KING && rvCOUNTDOWN == 0 && !f126 && vTREASURE_COUNT != 3) {
      set(fSPOKEN_TO_KING);
      set(rfWAIT_FOR_KEY);
      set(fNO_BUSINESS_WITH_KING);
      set.text.attribute(15, 0);
      text.screen();
      display(0, 4, "When you speak to King Edward,");
      display(1, 10, "he sighs and says,");
      display(2, 0, "\"Sir Graham, I am an old man. I fear");
      display(3, 0, " my end is near.  I have chosen you to");
      display(4, 0, " prove yourself worthy of the throne.");
      display(5, 0, "As you know, our kingdom is weak and");
      display(6, 0, " poor.  I have knowledge of the");
      display(7, 0, " existence of three things that would");
      display(8, 0, " make our kingdom wealthy and strong.");
      display(9, 0, "Somewhere within our kingdom, there is");
      display(10, 0, " a magic mirror that tells the future.");
      display(11, 0, " There is a magic shield that will");
      display(12, 0, " protect the bearer from mortal harm.");
      display(13, 0, " Finally, there is a magic chest that");
      display(14, 0, " is always filled with gold coins.");
      display(15, 0, "Go, Sir Graham!  Go and bring me");
      display(16, 0, " back these treasures.");
      display(17, 0, "If you succeed, you will inherit the");
      display(18, 0, " throne.\"");
      display(22, 5, "Press any key to continue.");
    }
  }
}
if (!posn(oEGO, 60, 85, 86, 113) && !rfNEAR_THRONE) {
  if (rvCOUNTDOWN == 0) {
    if (said("examine", "king")) {
      print("You are not close enough to see him clearly.");
    }
    if (said("examine", "throne")) {
      print("King Edward the Benevolent is sitting on the throne, waiting for you.");
    }
    if (said("bow", "king") || said("bow")) {
      print("It would show more respect if you were closer and in front of King Edward.");
    }
    if (said("talk", "king")) {
      print("It is proper to stand directly in front of, and a few paces back from King Edward when addressing His Eminence.");
    }
  }
}
if (said("kneel", "king")) {
  print("That's not a bad idea, but the custom in Daventry is to bow.");
}
if (said("murder", "king")) {
  if (rvCOUNTDOWN == 0) {
    print("To kill King Edward would mean immediate execution!");
  }
  if (rvCOUNTDOWN != 0) {
    print("Your concern for the old king won't allow you to move.");
  }
}
if (said("sit down", "throne")) {
  if (rvCOUNTDOWN == 0) {
    print("The throne is already occupied.");
  }
  else {
    print("You will have to do that yourself.");
  }
}
if (said("examine", "room") || said("examine", "building")) {
  print("This huge, tapestried room echoes every sound.");
}
if (said("hello") || said("say", "hello")) {
  print("That is no way to try and address King Edward.");
}
if (rfEGO_FINISHED_BOWING) {
  reset(rfEGO_FINISHED_BOWING);
  reset(fCYCLE_EGO_ANIMATION);
  get.posn(oEGO, vTEMP_X, vTEMP_Y);
  vTEMP_X += 7;
  erase(oEGO);
  set.loop(oEGO, 1);
  set.view(oEGO, 0);
  position.v(oEGO, vTEMP_X, vTEMP_Y);
  rvEGO_CYCLE_TIME = 1;
  cycle.time(oEGO, rvEGO_CYCLE_TIME);
  draw(oEGO);
  start.motion(oEGO);
  print("When you bow to King Edward, his pleased smile warms you.");
  if (fPOINTS_FOR_BOWING_TO_KING_AFTER_MISSION) {
    rvCOUNTDOWN = 250;
    v70 = 0;
    v71 = 0;
  }
}
if (rfWAIT_FOR_KEY) {
  vKEY_PRESSED = 0;
  while (!have.key()) { }
  reset(rfWAIT_FOR_KEY);
  graphics();
}
if (vEGO_EDGE_CODE == EDGE_RIGHT) {
  new.room(ROOM54_CASTLE_HALL_CORNER);
}
return;

LOGIC__FOOTER

