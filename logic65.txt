#include "vars.txt"

LOGIC__HEADER

#define oNOTE o1
#define oCUPBOARD o2
#define oSWISS_CHEESE o3
#define oWITCH o4

if (fROOM_SCRIPT_EXECUTED) {
  load.pic(vROOM_NO);
  draw.pic(vROOM_NO);
  discard.pic(vROOM_NO);
  load.sound(SND_VILLAIN);
  load.sound(SND_OUCH);
  load.sound(SND_FALLING);
  if (!fCARRYING_NOTE) {
    load.view(42);
    animate.obj(oNOTE);
    set.view(oNOTE, 42);
    position(oNOTE, 118, 140);
    set.priority(oNOTE, 14);
  }
  if (vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_NO_CHEESE) {
    load.view(40);
    animate.obj(oCUPBOARD);
    set.view(oCUPBOARD, 40);
    position(oCUPBOARD, 33, 76);
    set.cel(oCUPBOARD, 0);
    stop.cycling(oCUPBOARD);
  }
  if (vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_WITH_CHEESE) {
    load.view(40);
    animate.obj(oCUPBOARD);
    set.view(oCUPBOARD, 40);
    position(oCUPBOARD, 33, 76);
    set.cel(oCUPBOARD, 0);
    stop.cycling(oCUPBOARD);
    load.view(41);
    animate.obj(oSWISS_CHEESE);
    set.view(oSWISS_CHEESE, 41);
    position(oSWISS_CHEESE, 41, 61);
    set.priority(oSWISS_CHEESE, 8);
  }
  if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_NO_CHEESE) {
    load.view(40);
    animate.obj(oCUPBOARD);
    set.view(oCUPBOARD, 40);
    position(oCUPBOARD, 33, 76);
    set.cel(oCUPBOARD, 5);
    stop.cycling(oCUPBOARD);
  }
  if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_WITH_CHEESE) {
    load.view(40);
    animate.obj(oCUPBOARD);
    set.view(oCUPBOARD, 40);
    position(oCUPBOARD, 33, 76);
    set.cel(oCUPBOARD, 5);
    stop.cycling(oCUPBOARD);
    load.view(41);
    animate.obj(oSWISS_CHEESE);
    set.view(oSWISS_CHEESE, 41);
    position(oSWISS_CHEESE, 41, 61);
    set.priority(oSWISS_CHEESE, 8);
  }
  if (vPREV_ROOM_NO == 80) {
    load.view(105);
    load.view(103);
    load.view(104);
    set.view(oEGO, 105);
    ignore.blocks(oEGO);
    position(oEGO, 80, 45);
    set(f98);
    set(f25);
    program.control();
    move.obj(oEGO, 80, 84, 6, f20);
    vWITCH_STATE = WITCHSTATE_AWAY_FROM_HOME;
  }
  if (vPREV_ROOM_NO == 28) {
    position(oEGO, 49, 163);
  }
  if (!fPROTECTED_BY_SPELL
    && vWITCH_STATE != WITCHSTATE_DEAD
    && vPREV_ROOM_NO != 80
    && !fEGO_INVISIBLE
  ) {
    if (vWITCH_STATE == WITCHSTATE_AWAY_FROM_HOME) {
      random(0, 250, v62);
      if (v62 < 180) {
        load.view(43);
        animate.obj(oWITCH);
        set.view(oWITCH, 43);
        v30 = 250;
        v31 = 3;
      }
    }
  }
  if (vWITCH_STATE == WITCHSTATE_AT_HOME) {
    if (!fPROTECTED_BY_SPELL && !fEGO_INVISIBLE) {
      set(f27);
      load.view(43);
      animate.obj(oWITCH);
      set.view(oWITCH, 43);
      position(oWITCH, 26, 120);
    }
  }
  if (!fCARRYING_NOTE) {
    draw(oNOTE);
    stop.update(oNOTE);
  }
  draw(oCUPBOARD);
  if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_WITH_CHEESE) {
    draw(oSWISS_CHEESE);
  }
  ignore.blocks(oEGO);
  observe.blocks(oWITCH);
  draw(oEGO);
  show.pic();
  if (fPROTECTED_BY_SPELL) {
    print("Be thankful that you have a protective spell or the witch may have stuck around to try and catch you!");
  }
  if (fEGO_INVISIBLE) {
    print("Be thankful that you are invisible or the witch may have stuck around to try and catch you!");
  }
  if (f27) {
    draw(oWITCH);
    follow.ego(oWITCH, 10, f26);
    print("Surprise!  Surprise!  The wicked witch is home and now she's after you!");
  }
}
if (f27 && !f32) {
  set(f32);
  sound(SND_VILLAIN, f148);
}
if (fGOAT_COMPANION) {
  reset(fGOAT_COMPANION);
  set(fGOAT_IS_GONE);
  print("As soon as you entered the house the goat ran away.");
  vSCORE -= 5;
}
if (vWITCH_STATE == WITCHSTATE_DEAD) {
  if (said("anyword", "witch")) {
    print("The witch is dead.");
  }
}
if (vPREV_ROOM_NO == 80) {
  if (!f20 && !f33 && !f27) {
    sound(SND_FALLING, f198);
    set(f33);
  }
}
if (f198) {
  if (!f20 && !f34) {
    reset(f198);
    reset(f33);
  }
}
v32--;
if (f20) {
  stop.sound();
  set(f34);
  reset(f20);
  observe.blocks(oEGO);
  set.view(oEGO, 103);
  shake.screen(1);
  print("OUCH!");
  v32 = 20;
  set(f98);
  sound(SND_OUCH, fSOUND_END_MARKER);
}
if (fSOUND_END_MARKER) {
  if (v32 > 0) {
    reset(fSOUND_END_MARKER);
    sound(SND_OUCH, fSOUND_END_MARKER);
  }
}
if (v32 == 1) {
  set.view(oEGO, 104);
  end.of.loop(oEGO, f22);
  print("As the wicked witch flew over her house, she dropped you... into her cage!  If you can't get out, you may become the secret ingredient in this witches' brew!");
  player.control();
}
v33--;
if (f22) {
  reset(f22);
  reset(f98);
  set.view(oEGO, 0);
  v33 = 100;
}
if (v33 == 1) {
  if (f27 || f29) {
    print("With a flash, you hear her joyously exclaim, \"This has made me feel like flying!\"");
    erase(oWITCH);
    reset(f27);
  }
  else {
    print("Try as you will to escape, your labor will be in vain.");
  }
  set(f95);
  stop.cycling(oEGO);
  set(fGAME_OVER);
}
if (f27) {
  distance(oEGO, oWITCH, v34);
  if (v34 == 30 && !f30) {
    set(f30);
    stop.motion(oEGO);
    print("Rats!  She has cast some spell to keep you from escaping!. The witch remarks, \"Oh, how nice of you to come for dinner (cackle, cackle)\"");
  }
  if (f26) {
    reset(f26);
    print("She pokes and pinches you, then states, \"This one is too scrawny, so it's into the cage until you fatten up (smack, yum)!\"");
    erase(oEGO);
    position(oEGO, 80, 80);
    draw(oEGO);
    start.motion(oEGO);
    set(f22);
    set(f25);
  }
}
v30--;
if (v30 == 0) {
  if (v31 > 0) {
    v31--;
    v30 = 250;
  }
}
if (v30 == 1 && v31 == 3) {
  print("Off in the distance you hear a high, squeaky voice say, \"I can smell someone tasty in my house.\"");
}
if (v30 == 1 && v31 == 2) {
  position(oWITCH, 49, 160);
  draw(oWITCH);
  sound(SND_VILLAIN, f148);
  set(f29);
  if (posn(oEGO, 105, 1, 158, 166)) {
    move.obj(oWITCH, 26, 120, 2, f21);
    set(f31);
    print("The witch mutters, \"I am going to get my oven ready to cook someone for dinner (yum).\"");
  }
}
if (f29 && !f21 && !f31) {
  v30 = 0;
  v31 = 0;
  if (posn(oEGO, 105, 1, 158, 166) && !f23) {
    wander(oWITCH);
  }
  else {
    if (!f23) {
      set(f23);
      ignore.blocks(oWITCH);
      follow.ego(oWITCH, 10, f26);
    }
    distance(oEGO, oWITCH, v34);
    if (v34 < 30 && !f30 && !posn(oEGO, 105, 132, 158, 166)) {
      set(f30);
      stop.motion(oEGO);
      print("Rats!  She has cast some spell to keep you from escaping!. The witch remarks, \"Oh, how nice of you to come for dinner (cackle, cackle)\"");
    }
    if (f26) {
      reset(f26);
      print("She pokes and pinches you, then states, \"This one is too scrawny, so it's into the cage until you fatten up (smack, yum)!\"");
      reposition.to(oEGO, 80, 80);
      start.motion(oEGO);
      set(f22);
      set(f25);
    }
  }
}
if (f21) {
  if (said("examine", "witch")) {
    print("This ugly old witch is one of the most hideous sights you have ever seen.  I would never trust her.");
  }
  distance(oEGO, oWITCH, v70);
  if (v70 < 15) {
    if (said("shove", "witch") || said("murder", "witch")) {
      erase(oWITCH);
      print("Courageously, you manage to push the witch into the oven where she flashes and melts away into a harmless blob. Congratulations!");
      vWITCH_STATE = WITCHSTATE_DEAD;
      v30 = 0;
      v31 = 0;
      reset(f29);
      reset(f21);
      vSCORE += 7;
    }
  }
  if (v70 > 14) {
    if (said("shove", "witch") || said("murder", "witch")) {
      print("You are in no position to do that!");
    }
  }
  if (v30 == 1 && v31 == 3) {
    print("The witch mumbles, \"After I get the oven nice and hot, I will be ready to have someone for dinner (giggle).\"");
  }
  if (v30 == 1 && v31 == 2) {
    print("The witch mutters, \"The oven is heating up nicely.  I wonder who will be my dinner guest!\"");
  }
  if (v30 == 1 && v31 == 0) {
    v30 = 0;
    v31 = 0;
    print("The witch says, \"My oven is now the perfect temperature. It is time to invite someone for dinner (cackle, cackle)!\"");
    reset(f21);
    reset(f31);
    if (posn(oEGO, 100, 1, 158, 166)) {
      wander(oWITCH);
    }
  }
}
if (!f21) {
  if (f29 || f27) {
    if (said("shove", "witch")) {
      print("You are in no position to do that!");
    }
    if (said("murder", "witch")) {
      print("If I were you, I wouldn't try it!  This witch is mean!");
    }
    if (said("examine", "witch")) {
      print("This ugly old witch is one of the most hideous sights you have ever seen.  I would never trust her.");
    }
  }
}
if (vWITCH_STATE != WITCHSTATE_DEAD) {
  if (!f29 && !f27) {
    if (said("anyword", "witch")) {
      print("There is no witch here...RIGHT NOW!!");
    }
  }
}
if (f29 || f27) {
  if (said("talk", "witch")) {
    print("Now is not a good time to try and start a conversation!");
  }
  if (said("hello") || said("say", "hello")) {
    print("Now is not a good time to try and start a conversation!");
  }
}
if (said("open", "cage")) {
  print("It is fastened with a very strong lock.  There is no way for you to open it.");
}
if (said("examine", "building")) {
  print("The little house is surprisingly neat considering a wicked witch lives here.");
}
if (posn(oEGO, 23, 89, 55, 100)) {
  if (said("examine", "cupboard") || said("look inside", "cupboard")) {
    if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_NO_CHEESE) {
      print("There is nothing but a bare shelf here.");
    }
    if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_WITH_CHEESE) {
      print("Sitting on the shelf is a delicious piece of Swiss cheese.");
    }
    if (vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_WITH_CHEESE
      || vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_NO_CHEESE
    ) {
      print("The cabinet on the wall is rather plain and simple.");
    }
  }
  if (said("open", "cupboard")) {
    if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_WITH_CHEESE
      || vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_NO_CHEESE
    ) {
      print("It is already open.");
    }
    if (vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_NO_CHEESE) {
      start.cycling(oCUPBOARD);
      end.of.loop(oCUPBOARD, f148);
      vCUPBOARD_STATE = CUPBOARDSTATE_OPEN_NO_CHEESE;
    }
    if (vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_WITH_CHEESE) {
      start.cycling(oCUPBOARD);
      end.of.loop(oCUPBOARD, f24);
      vCUPBOARD_STATE = CUPBOARDSTATE_OPEN_WITH_CHEESE;
      if (!fPOINTS_FOR_FINDING_CHEESE) {
        set(fPOINTS_FOR_FINDING_CHEESE);
        vSCORE += 2;
      }
    }
  }
  if (said("close", "cupboard")) {
    if (vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_WITH_CHEESE
      || vCUPBOARD_STATE == CUPBOARDSTATE_CLOSED_NO_CHEESE
    ) {
      print("It is already closed.");
    }
    if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_NO_CHEESE) {
      reverse.loop(oCUPBOARD, f148);
      vCUPBOARD_STATE = CUPBOARDSTATE_CLOSED_NO_CHEESE;
    }
    if (vCUPBOARD_STATE == CUPBOARDSTATE_OPEN_WITH_CHEESE) {
      reverse.loop(oCUPBOARD, f148);
      erase(oSWISS_CHEESE);
      vCUPBOARD_STATE = CUPBOARDSTATE_CLOSED_WITH_CHEESE;
    }
  }
  if (!fCARRYING_SWISS_CHEESE) {
    if (said("get", "swiss cheese")) {
      if (vCUPBOARD_STATE == 1) {
        erase(oSWISS_CHEESE);
        get("cheese");
        set(fCARRYING_SWISS_CHEESE);
        vSCORE += 2;
        print("You pluck the Swiss cheese from the shelf.");
        vCUPBOARD_STATE = 3;
      }
      if (vCUPBOARD_STATE == 0 || vCUPBOARD_STATE == 2) {
        print("I don't see any here.");
      }
    }
    if (said("examine", "swiss cheese")) {
      if (vCUPBOARD_STATE == 0 || vCUPBOARD_STATE == 2) {
        print("I don't see any here.");
      }
      if (vCUPBOARD_STATE == 3) {
        print("I don't see any here.");
      }
      if (vCUPBOARD_STATE == 1) {
        print("Sitting on the shelf is a delicious piece of Swiss cheese.");
      }
    }
  }
}
if (!posn(oEGO, 23, 89, 55, 100)) {
  if (said("examine", "cupboard")) {
    print("You need to be a little closer for a good look.");
  }
  if (said("open", "cupboard") || said("close", "cupboard")) {
    print("You need to be closer to do that.");
  }
  if (!fCARRYING_SWISS_CHEESE) {
    if (said("examine", "swiss cheese")) {
      print("You cannot see it from here.");
    }
    if (said("get", "swiss cheese")) {
      print("I don't see any here.");
    }
  }
}
if (f24) {
  reset(f24);
  draw(oSWISS_CHEESE);
}
if (said("examine", "stove")) {
  if (posn(oEGO, 4, 88, 106, 160)) {
    print("It is an old wood stove, and very hot.  The fire must have been burning for some time.");
  }
  else {
    print("You may have seen one in the other room, but I am not sure.");
  }
}
if (said("examine", "cage")) {
  if (f25) {
    if (vPREV_ROOM_NO == 80) {
      print("This cage will be your new home for the rest of your life.");
    }
    if (vPREV_ROOM_NO == 28) {
      print("You look for a way to escape, but there is none.");
    }
  }
  if (!f25) {
    if (posn(oEGO, 4, 88, 106, 160)) {
      print("It is made from rusty, but strong, iron bars.");
    }
    else {
      print("You cannot see it from here.");
    }
  }
}
if (said("feel", "stove")) {
  if (posn(oEGO, 8, 88, 40, 144)) {
    print("The oven is very, very hot.  Someone must have just put some wood in it.");
  }
  else {
    print("You are not close enough to touch it.");
  }
}
if (said("open", "stove")) {
  if (posn(oEGO, 8, 88, 40, 144)) {
    print("You open the door and see a roaring fire burning in the oven.");
  }
  else {
    print("From here it would be rather difficult to open the oven.");
  }
}
if (posn(oEGO, 105, 88, 158, 160)) {
  if (said("examine", "table")) {
    if (fCARRYING_NOTE) {
      print("It is just a plain, wooden bedside table.");
    }
    else {
      print("There is a note lying on top of it.");
    }
  }
  if (said("examine", "bed")) {
    print("The witch's bed looks hard and uncomfortable.");
  }
  if (said("sleep") || said("sleep", "bed") || said("get", "nap")) {
    print("You wouldn't want to sleep on a witch's bed.");
  }
}
if (!posn(oEGO, 105, 88, 158, 160)) {
  if (said("examine", "table")) {
    print("That is the table where she eats her (gulp) food.");
  }
  if (said("examine", "bed")) {
    print("The bed is not here.");
  }
  if (said("sleep") || said("sleep", "bed") || said("get", "nap")) {
    print("The bed is not here.");
  }
}
if (said("examine", "window")) {
  if (posn(oEGO, 115, 88, 140, 108)) {
    print("You see the forest outside.");
  }
  else {
    print("There is little to see from here.");
  }
}
if (!fCARRYING_NOTE) {
  if (said("examine", "note")) {
    if (posn(oEGO, 114, 132, 140, 160)) {
      print("It is written in a familiar language.");
    }
    else {
      print("Your eyes are not sharp enough to see it from here.");
    }
  }
  if (said("get", "note")) {
    if (posn(oEGO, 114, 132, 140, 160)) {
      start.update(oNOTE);
      erase(oNOTE);
      set(fCARRYING_NOTE);
      get("note");
      print("You grab the note from the table.");
      vSCORE += 2;
    }
    else {
      print("You cannot reach it from here.");
    }
  }
}
if (posn(oEGO, 39, 164, 56, 166)) {
  new.room(28);
}
return;

LOGIC__FOOTER

