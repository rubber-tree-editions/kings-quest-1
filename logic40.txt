#include "vars.txt"

LOGIC__HEADER

#define oGNOME o1
#define oMAGIC_BEANS o2
#define oGOLD_KEY o3

if (fROOM_SCRIPT_EXECUTED) {
  load.pic(vROOM_NO);
  draw.pic(vROOM_NO);
  discard.pic(vROOM_NO);
  set.horizon(42);
  load.logics(LOGIC_SWIMMING);
  call(LOGIC_SWIMMING);
  ignore.blocks(oEGO);
  if (vGNOME_STATE <= GNOMESTATE_PRESENT) {
    load.view(27);
    animate.obj(oGNOME);
    set.view(oGNOME, 27);
    position(oGNOME, 34, 104);
    observe.blocks(oGNOME);
    wander(oGNOME);
    load.view(29);
    animate.obj(oMAGIC_BEANS);
    set.view(oMAGIC_BEANS, 29);
    position(oMAGIC_BEANS, 39, 118);
    ignore.objs(oMAGIC_BEANS);
    load.view(28);
    animate.obj(oGOLD_KEY);
    set.view(oGOLD_KEY, 28);
    position(oGOLD_KEY, 39, 118);
    ignore.objs(oGOLD_KEY);
  }
  if (vGNOME_STATE == GNOMESTATE_LEFT_BEANS && vTAKEN_GNOME_GIFT != GNOMEGIFT_BEANS) {
    set(f20);
    load.view(29);
    animate.obj(oMAGIC_BEANS);
    set.view(oMAGIC_BEANS, 29);
    position(oMAGIC_BEANS, 39, 118);
  }
  if (vGNOME_STATE == GNOMESTATE_LEFT_KEY && vTAKEN_GNOME_GIFT != GNOMEGIFT_KEY) {
    set(f21);
    load.view(28);
    animate.obj(oGOLD_KEY);
    set.view(oGOLD_KEY, 28);
    position(oGOLD_KEY, 39, 118);
  }
  if (vGNOME_STATE <= GNOMESTATE_PRESENT) {
    draw(oGNOME);
    set(f23);
  }
  if (f21) {
    draw(oGOLD_KEY);
    stop.update(oGOLD_KEY);
  }
  if (f20) {
    draw(oMAGIC_BEANS);
    stop.update(oMAGIC_BEANS);
  }
  set(f68);
  draw(oEGO);
  show.pic();
}
if (said("examine", "building")) {
  print("The gnome's lean-to doesn't look very sturdy.");
}
if (f23 && !f24) {
  print("You see a crotchety old gnome pacing around his lean-to.");
  set(f24);
}
if (f23) {
  distance(oEGO, oGNOME, v62);
  if (f22) {
    if (said("talk", "man") || said("hello") || said("say", "hello")) {
      if (v62 < 50) {
        print("You still haven't guessed my name!");
      }
      else {
        print("The gnome can't hear you from there.");
      }
      goto(LABEL898);
    }
  }
  if (!f22) {
    if (said("talk", "man") || said("hello") || said("say", "hello")) {
      if (v62 < 50) {
        set(f22);
        print("The old gnome tells you he has something that may be very useful to you.  Your task is to guess his name in three guesses and his gift will be yours.  Good luck!  What is your first guess?");
      }
      else {
        print("The gnome can't hear you from there.");
      }
      goto(LABEL898);
    }
  }
  if (said("examine", "man")) {
    if (v62 < 80) {
      print("The gnome is old and bent under the weight of years, but a playful wisdom still brightens his eyes.");
    }
    else {
      print("You should get a little closer.");
    }
    goto(LABEL898);
  }
  if (said("murder", "man")) {
    print("It would be unwise to kill a gnome.");
    goto(LABEL898);
  }
}
if (f22) {
  if (said("rumplestiltskin") && vGNOME_NAME_GUESSES != 2) {
    print("That is very close but not quite right!");
    vGNOME_NAME_GUESSES++;
    goto(LABEL898);
  }
  if (said("nikstlitselpmur") && vGNOME_NAME_GUESSES != 2) {
    print("You have the right idea, but your thinking is just a little bit off.");
    vGNOME_NAME_GUESSES++;
    goto(LABEL898);
  }
  if (said("mikel knight") && vGNOME_NAME_GUESSES != 2) {
    print("What do you think I am, a car?  This also won't get you a raise.  Nice try.");
    vGNOME_NAME_GUESSES++;
    goto(LABEL898);
  }
  if (said("ifnkovhgroghprm")) {
    erase(oGNOME);
    reset(f22);
    reset(f23);
    draw(oMAGIC_BEANS);
    set(f20);
    stop.update(oMAGIC_BEANS);
    vGNOME_STATE = GNOMESTATE_LEFT_BEANS;
    print("That's right!!!  You've guessed it!!  Here are some magic beans for your outstanding accomplishment!");
    if (vGNOME_NAME_GUESSES <= 0) {
      vSCORE += 5;
    }
    if (vGNOME_NAME_GUESSES == 1) {
      vSCORE += 4;
    }
    if (vGNOME_NAME_GUESSES == 2) {
      vSCORE += 3;
    }
    goto(LABEL898);
  }
  if (vGNOME_NAME_GUESSES <= 0) {
    if (said("anyword") || said("anyword", "anyword")) {
      accept.input();
      print("Where did you get that idea?  That's not even close!");
      vGNOME_NAME_GUESSES++;
      goto(LABEL898);
    }
  }
  if (vGNOME_NAME_GUESSES == 1) {
    if (said("anyword") || said("anyword", "anyword")) {
      accept.input();
      print("You know that's not right!");
      print("What is your next guess?");
      vGNOME_NAME_GUESSES++;
      goto(LABEL898);
    }
  }
  if (vGNOME_NAME_GUESSES == 2) {
    if (said("anyword") || said("anyword", "anyword")) {
      accept.input();
      erase(oGNOME);
      reset(f22);
      reset(f23);
      draw(oGOLD_KEY);
      set(f21);
      stop.update(oGOLD_KEY);
      vGNOME_STATE = GNOMESTATE_LEFT_KEY;
      print("You didn't guess the gnome's name, but he left you a gold key anyway.  Better luck next time!");
      vGNOME_NAME_GUESSES = 3;
      goto(LABEL898);
    }
  }
}
if (!f23) {
  if (said("anyword", "man")) {
    print("There is no gnome here.");
  }
  if (f20) {
    distance(oEGO, oMAGIC_BEANS, v70);
    if (said("examine", "magic beans")) {
      if (v70 > 40) {
        print("That's too far away.");
      }
      else {
        print("They look like beans.  Interesting.");
      }
    }
    if (said("get", "magic beans")) {
      if (v70 > 20) {
        print("That's too far away.");
      }
      else {
        print("Being careful that you get every one of them, you place the beans in your pocket.");
        reset(f20);
        start.update(oMAGIC_BEANS);
        erase(oMAGIC_BEANS);
        set(fCARRYING_MAGIC_BEANS);
        get("beans");
        vTAKEN_GNOME_GIFT = GNOMEGIFT_BEANS;
        vSCORE += 4;
      }
    }
  }
  if (f21) {
    distance(oEGO, oGOLD_KEY, v71);
    if (said("examine", "gold key")) {
      if (v71 > 40) {
        print("That's too far away.");
      }
      else {
        print("It is a heavy, gold, skeleton key.");
      }
    }
    if (said("get", "gold key")) {
      if (v71 > 20) {
        print("That's too far away.");
      }
      else {
        print("It is heavy and cold.");
        reset(f21);
        start.update(oGOLD_KEY);
        erase(oGOLD_KEY);
        set(fCARRYING_GOLD_KEY);
        get("key");
        vTAKEN_GNOME_GIFT = GNOMEGIFT_KEY;
        vSCORE += 3;
      }
    }
  }
}
if (!f20 && !fCARRYING_MAGIC_BEANS) {
  if (said("anyword", "magic beans")) {
    print("There are no beans here.");
  }
}
if (!f21 && !fCARRYING_GOLD_KEY) {
  if (said("anyword", "gold key")) {
    print("The key to your problems is elsewhere.");
  }
}
if (fEGO_ON_WATER && !f25) {
  set(f25);
  print("You slip down the bank into the river far below.  Your cries for help are not heard.");
}
if (v94 <= 0 && fEGO_ON_WATER) {
  v76 = 255;
  if (posn(oEGO, 0, 34, 34, 67)) {
    v76 = 6;
    v77 = 54;
  }
  if (v76 == 255) {
    v76 = 0;
  }
  else {
    get.posn(oEGO, v60, v61);
    v76 -= v60;
    v77 -= v61;
    set(f134);
  }
}
if (!fBUCKET_FILLED && !fEGO_ON_WATER && !f116) {
  if (said("drink", "water") || said("get", "drink")) {
    print("There is no place to safely get a drink.");
  }
}
if (!fBUCKET_FILLED && fCARRYING_BUCKET && !fEGO_ON_WATER && said("get", "water")) {
  print("There is no place to safely get water.");
}
LABEL898:
  if (vEGO_EDGE_CODE == EDGE_HORIZON) {
    new.room(41);
  }
  if (vEGO_EDGE_CODE == EDGE_RIGHT) {
    new.room(39);
  }
  if (vEGO_EDGE_CODE == EDGE_LEFT) {
    new.room(33);
  }
  if (vEGO_EDGE_CODE == EDGE_BOTTOM) {
    new.room(25);
  }
  call(LOGIC_SWIMMING);
  return;

LOGIC__FOOTER

